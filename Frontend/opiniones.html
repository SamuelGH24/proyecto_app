<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Opiniones - UANFilms</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0 1rem; background:#f5f5f5; color:#222; }
    header { display:flex; align-items:center; justify-content:space-between; padding:1rem 0; }
    nav a { margin-left:0.5rem; text-decoration:none; color:#0366d6; font-weight:600; }
    main { max-width:800px; margin:1.5rem auto; background:#fff; padding:1rem 1.25rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    h1 { margin-top:0; color:#333; }
    .opinion-list { margin-top:1.5rem; }
    .opinion { background:#f9f9f9; padding:.75rem; border-radius:6px; margin-bottom:.75rem; border:1px solid #ddd; }
    .opinion strong { color:#0366d6; }
    .opinion small { color:#555; display:block; margin-top:.25rem; }
    .empty { text-align:center; color:#777; margin-top:1rem; }
    footer { text-align:center; padding:1rem 0; color:#666; }
    button { background:#0366d6; color:white; border:none; padding:.5rem 1rem; border-radius:6px; cursor:pointer; }
    button.secondary { background:#6c757d; }
    textarea { width:100%; min-height:80px; border:1px solid #ccc; border-radius:6px; padding:.5rem; resize:vertical; }
    select { padding:.4rem; border:1px solid #ccc; border-radius:6px; }
    form { margin-top:1.5rem; background:#f8f8f8; padding:1rem; border-radius:8px; border:1px solid #ddd; }
    form h3 { margin-top:0; }
  </style>
</head>
<body>
  <header>
    <h1>üé¨ UANFilms</h1>
    <nav id="mainNav">
      <a href="index.html">Inicio</a>
      <a href="add-item.html">Agregar Pel√≠cula</a>
      <a href="Login.html">Iniciar Sesi√≥n</a>
      <a href="Resgistrer.html">Registrarse</a>
    </nav>
  </header>

  <main>
    <h2 id="movieTitle">Opiniones sobre la pel√≠cula</h2>
    <p id="movieInfo" style="color:#555;"></p>

    <section id="opiniones" class="opinion-list">
      <p class="empty">Cargando opiniones...</p>
    </section>

    <!-- FORMULARIO DE NUEVA OPINI√ìN -->
    <form id="opinionForm" style="display:none;">
      <h3>Escribe tu opini√≥n</h3>
      <label for="calificacion">Calificaci√≥n:</label>
      <select id="calificacion" required>
        <option value="">Selecciona una</option>
        <option value="1">‚≠ê 1</option>
        <option value="2">‚≠ê‚≠ê 2</option>
        <option value="3">‚≠ê‚≠ê‚≠ê 3</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4</option>
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5</option>
      </select>

      <label for="texto">Tu rese√±a:</label>
      <textarea id="texto" placeholder="Escribe tu opini√≥n..." required></textarea>

      <button type="submit">Publicar opini√≥n</button>
    </form>

    <div style="text-align:center; margin-top:1.5rem;">
      <button onclick="window.location.href='index.html'" class="secondary">‚¨Ö Volver al inicio</button>
    </div>
  </main>

  <footer>
    ¬© UANFilms ‚Äî Secci√≥n de opiniones.
  </footer>

  <script>
    const params = new URLSearchParams(window.location.search);
    const peliculaId = params.get('pelicula');
    const opinionesContainer = document.getElementById('opiniones');
    const form = document.getElementById('opinionForm');
    const user = JSON.parse(localStorage.getItem('uanfilmsUser'));

    // === SESI√ìN ===
    (function(){
      const nav = document.getElementById('mainNav');
      if (user) {
        nav.innerHTML = `
          <a href="index.html">Inicio</a>
          <a href="add-item.html">Agregar Pel√≠cula</a>
          <a href="perfil.html">Mi Perfil</a>
          <button id="logoutBtn" style="background:#d33;color:white;border:none;border-radius:6px;padding:.3rem .6rem;cursor:pointer;">Cerrar sesi√≥n</button>
        `;
        document.getElementById('logoutBtn').addEventListener('click', () => {
          localStorage.removeItem('uanfilmsUser');
          location.href = 'index.html';
        });
      }
    })();

    // === CARGAR OPINIONES ===
    async function cargarOpiniones() {
      if (!peliculaId) {
        opinionesContainer.innerHTML = '<p class="empty">Pel√≠cula no especificada.</p>';
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/api/resenas/${peliculaId}`);
        if (!res.ok) throw new Error('No se pudieron obtener las opiniones.');
        const data = await res.json();

        opinionesContainer.innerHTML = '';
        if (data.length === 0) {
          opinionesContainer.innerHTML = '<p class="empty">A√∫n no hay opiniones registradas.</p>';
        } else {
          data.forEach(op => {
            const div = document.createElement('div');
            div.className = 'opinion';
            div.innerHTML = `
              <strong>${op.usuario_nombre}</strong> ‚Äî ${'‚≠ê'.repeat(op.calificacion)}
              <p>${op.texto}</p>
              <small>${new Date(op.fecha).toLocaleString()}</small>
            `;
            opinionesContainer.appendChild(div);
          });
        }
      } catch (err) {
        opinionesContainer.innerHTML = `<p class="empty" style="color:red;">${err.message}</p>`;
      }
    }

    // === ENVIAR NUEVA OPINI√ìN ===
    async function enviarOpinion(e) {
      e.preventDefault();
      const texto = document.getElementById('texto').value.trim();
      const calificacion = document.getElementById('calificacion').value;

      if (!texto || !calificacion) return alert('Completa todos los campos.');

      try {
        const res = await fetch('http://localhost:3000/api/resenas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            usuario_id: user.id,
            pelicula_id: peliculaId,
            texto,
            calificacion
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error al guardar la rese√±a.');

        alert('Opini√≥n publicada con √©xito.');
        form.reset();
        cargarOpiniones();
      } catch (err) {
        alert(err.message);
      }
    }

    // === SI EST√Å LOGEADO, MUESTRA EL FORMULARIO ===
    if (user) {
      form.style.display = 'block';
      form.addEventListener('submit', enviarOpinion);
    }

    // === CARGA INICIAL ===
    cargarOpiniones();
  </script>
</body>
</html>
